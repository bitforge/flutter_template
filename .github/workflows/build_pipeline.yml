name: ğŸ“¦ ğŸš€ Build Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ "develop", "release", "main" ]
  pull_request:
    branches: [ "develop" ]

jobs:
  setup:
    name: ğŸš¦ Setup
    runs-on: self-hosted
    outputs:
      build_number: ${{ steps.buildnumber.outputs.BUILD_NUMBER }}
    steps:
      # Checkout branch (https://github.com/actions/checkout)
      - name: ğŸ¦„ Checkout repository
        uses: actions/checkout@v4

      # Install dependencies
      - name: ğŸ› ï¸ Install dependencies
        run: flutter pub get

      # Get incremental build number
      # https://github.com/onyxmueller/build-tag-number
      - name: ğŸ—³ï¸ Get build number
        id: buildnumber
        uses: onyxmueller/build-tag-number@v1
        with:
          token: ${{secrets.github_token}}

  test:
    name: ğŸ§‘â€ğŸ”¬ Test
    runs-on: self-hosted
    needs: setup
    steps:
      # Static code analysis (https://dart.dev/tools/analysis)
      - name: ğŸ” Analyze code
        run: flutter analyze --no-fatal-infos --fatal-warnings

      # Run tests
      - name: ğŸ§ª Run tests
        run: flutter test

  buildAndroid:
    name: ğŸ¤– Android
    runs-on: self-hosted
    needs: [ setup, test ]
    steps:
      # Put Android signing keys in place
      - name: ğŸ” Create keystore file
        env:
          KEYSTORE_JKS: ${{ secrets.ANDROID_KEYSTORE_JKS }}
          KEYSTORE_PROPERTIES: ${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}
        run: |
          echo $KEYSTORE_JKS | base64 --decode > "${{ github.workspace }}/android/app/keystore.jks"
          echo $KEYSTORE_PROPERTIES | base64 --decode > "${{ github.workspace }}/android/keystore.properties"

      # Build Signed Android App Bundle
      - name: ğŸ“¦ Build Android App
        run: |
          flutter build appbundle \
            --build-number ${{ needs.setup.outputs.build_number }} \
            --split-debug-info=symbols/android \
            --obfuscate \
            --release

  buildiOS:
    name: ğŸ iOS
    runs-on: self-hosted
    needs: [ setup, test ]
    steps:
      # Unlock Xcode Signing Key
      - name: ğŸ” Unlock keychain
        run: security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}"

      # Build Signed IPA for AppStore / TestFlight
      - name: ğŸ“¦ Build iOS App
        run: |
          flutter build ipa \
            --build-number ${{ needs.setup.outputs.build_number }} \
            --export-options-plist=ios/Runner/export_options.plist \
            --split-debug-info=symbols/ios \
            --obfuscate \
            --release